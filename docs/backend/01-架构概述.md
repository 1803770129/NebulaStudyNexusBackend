# 后端架构概述

## NestJS 简介

NestJS 是一个用于构建高效、可扩展的 Node.js 服务端应用的框架，使用 TypeScript 编写，借鉴了 Angular 的设计思想。

## 核心概念

### 1. 模块 (Module)

模块是组织代码的基本单元，每个应用至少有一个根模块。

```typescript
// app.module.ts
@Module({
  imports: [AuthModule, UserModule, QuestionModule],  // 导入其他模块
  controllers: [AppController],                        // 控制器
  providers: [AppService],                             // 服务提供者
})
export class AppModule {}
```

### 2. 控制器 (Controller)

处理 HTTP 请求，定义路由。

```typescript
@Controller('questions')
export class QuestionController {
  @Get()
  findAll() { ... }
  
  @Post()
  create(@Body() dto: CreateQuestionDto) { ... }
  
  @Get(':id')
  findOne(@Param('id') id: string) { ... }
}
```

### 3. 服务 (Service)

包含业务逻辑，可被注入到控制器或其他服务。

```typescript
@Injectable()
export class QuestionService {
  constructor(
    @InjectRepository(Question)
    private questionRepository: Repository<Question>,
  ) {}
  
  async create(dto: CreateQuestionDto) {
    const question = this.questionRepository.create(dto);
    return this.questionRepository.save(question);
  }
}
```

### 4. 守卫 (Guard)

用于认证和授权。

```typescript
@Injectable()
export class JwtAuthGuard extends AuthGuard('jwt') {
  canActivate(context: ExecutionContext) {
    // 检查是否有 @Public() 装饰器
    const isPublic = this.reflector.get('isPublic', context.getHandler());
    if (isPublic) return true;
    return super.canActivate(context);
  }
}
```

### 5. 管道 (Pipe)

用于数据转换和验证。

```typescript
// 全局验证管道
app.useGlobalPipes(new ValidationPipe({
  whitelist: true,      // 剥离非 DTO 属性
  transform: true,      // 自动类型转换
  forbidNonWhitelisted: true,
}));
```

### 6. 拦截器 (Interceptor)

在请求处理前后执行额外逻辑。

```typescript
@Injectable()
export class TransformInterceptor implements NestInterceptor {
  intercept(context: ExecutionContext, next: CallHandler) {
    return next.handle().pipe(
      map(data => ({
        statusCode: 200,
        message: 'success',
        data,
        timestamp: new Date().toISOString(),
      })),
    );
  }
}
```

## 项目文件结构

```
src/
├── main.ts                 # 入口文件
├── app.module.ts           # 根模块
├── common/                 # 公共模块
│   ├── decorators/
│   │   └── public.decorator.ts    # @Public() 装饰器
│   ├── dto/
│   │   └── pagination-response.dto.ts
│   ├── filters/
│   │   └── all-exceptions.filter.ts
│   └── interceptors/
│       └── transform.interceptor.ts
├── config/
│   └── configuration.ts    # 配置加载
└── modules/
    ├── auth/               # 认证模块
    ├── user/               # 用户模块
    ├── category/           # 分类模块
    ├── tag/                # 标签模块
    ├── question/           # 题目模块
    ├── content/            # 内容处理模块
    └── upload/             # 上传模块
```

## 模块结构模板

每个业务模块通常包含：

```
modules/question/
├── question.module.ts      # 模块定义
├── question.controller.ts  # 控制器
├── question.service.ts     # 服务
├── dto/                    # 数据传输对象
│   ├── create-question.dto.ts
│   ├── update-question.dto.ts
│   └── query-question.dto.ts
├── entities/               # 数据库实体
│   └── question.entity.ts
└── enums/                  # 枚举定义
    ├── question-type.enum.ts
    └── difficulty-level.enum.ts
```

## 请求生命周期

```
Request
   ↓
Middleware (中间件)
   ↓
Guards (守卫) - 认证/授权
   ↓
Interceptors (拦截器) - 前置处理
   ↓
Pipes (管道) - 数据验证/转换
   ↓
Controller (控制器)
   ↓
Service (服务)
   ↓
Interceptors (拦截器) - 后置处理
   ↓
Exception Filters (异常过滤器)
   ↓
Response
```

## 环境配置

```typescript
// config/configuration.ts
export default () => ({
  port: parseInt(process.env.PORT, 10) || 3000,
  database: {
    host: process.env.DB_HOST || 'localhost',
    port: parseInt(process.env.DB_PORT, 10) || 5432,
    username: process.env.DB_USERNAME || 'postgres',
    password: process.env.DB_PASSWORD || 'password',
    database: process.env.DB_DATABASE || 'question_manager',
  },
  jwt: {
    secret: process.env.JWT_SECRET,
    expiresIn: process.env.JWT_EXPIRES_IN || '15m',
    refreshExpiresIn: process.env.JWT_REFRESH_EXPIRES_IN || '7d',
  },
});
```

## 数据库配置 (TypeORM)

```typescript
// app.module.ts
TypeOrmModule.forRootAsync({
  imports: [ConfigModule],
  inject: [ConfigService],
  useFactory: (configService: ConfigService) => ({
    type: 'postgres',
    host: configService.get('database.host'),
    port: configService.get('database.port'),
    username: configService.get('database.username'),
    password: configService.get('database.password'),
    database: configService.get('database.database'),
    entities: [__dirname + '/**/*.entity{.ts,.js}'],
    synchronize: process.env.NODE_ENV === 'development', // 开发环境自动同步
  }),
}),
```
