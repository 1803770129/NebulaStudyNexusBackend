# CDN URL 迁移指南

本指南说明如何使用迁移脚本将数据库中的 jsDelivr CDN URL 迁移到 Statically CDN URL。

## 背景

由于 jsDelivr CDN 在某些地区存在连接超时问题，我们决定迁移到更稳定的 Statically CDN。迁移脚本会自动更新数据库中所有问题（Question）实体的图片 URL。

## 迁移范围

脚本会更新以下字段中的 URL：
- `content.rendered` - 问题内容
- `explanation.rendered` - 问题解析
- `options[].content.rendered` - 选项内容

## URL 格式转换

**jsDelivr 格式：**
```
https://cdn.jsdelivr.net/gh/{owner}/{repo}@{branch}/{path}
```

**Statically 格式：**
```
https://cdn.statically.io/gh/{owner}/{repo}@{branch}/{path}
```

## 使用方法

### 1. 试运行（推荐先执行）

试运行模式会模拟迁移过程，但不会实际修改数据库。这样可以预览迁移结果。

```bash
cd question-backend
npm run migration:cdn -- --dry-run
```

### 2. 执行迁移

确认试运行结果无误后，执行实际迁移：

```bash
npm run migration:cdn
```

### 3. 回滚迁移

如果需要回滚到 jsDelivr URL：

```bash
npm run migration:cdn -- --rollback
```

### 4. 回滚试运行

先试运行回滚操作：

```bash
npm run migration:cdn -- --rollback --dry-run
```

## 高级选项

### 自定义批处理大小

默认批处理大小为 100 条记录。可以通过 `--batch-size` 参数自定义：

```bash
npm run migration:cdn -- --batch-size=50
```

### 组合参数

可以组合多个参数：

```bash
npm run migration:cdn -- --dry-run --batch-size=200
```

## 迁移报告

脚本执行完成后会生成详细的迁移报告，包括：

- **总记录数**：数据库中的问题总数
- **更新记录数**：成功更新的记录数
- **跳过记录数**：不包含 jsDelivr URL 的记录数
- **失败记录数**：更新失败的记录数
- **成功率**：更新成功的百分比
- **错误详情**：失败记录的 ID 和错误信息

示例报告：

```
============================================================
迁移报告
============================================================

总记录数: 150
更新记录数: 145
跳过记录数: 3
失败记录数: 2

成功率: 96.67%

错误详情:
------------------------------------------------------------
记录 ID: abc-123
错误: Invalid URL format

记录 ID: def-456
错误: Database constraint violation

============================================================
```

## 注意事项

### 迁移前

1. **备份数据库**：强烈建议在执行迁移前备份数据库
2. **先试运行**：务必先执行试运行模式，检查迁移结果
3. **检查环境**：确保数据库连接配置正确
4. **停止服务**：建议在低峰期执行，并暂停相关服务

### 迁移中

1. **不要中断**：迁移过程中不要中断脚本执行
2. **监控日志**：关注控制台输出的日志信息
3. **检查错误**：如果出现错误，记录错误信息

### 迁移后

1. **验证结果**：检查迁移报告，确认成功率
2. **测试功能**：测试图片加载功能是否正常
3. **监控性能**：观察 Statically CDN 的性能表现
4. **保留备份**：保留数据库备份一段时间，以便回滚

## 故障排查

### 问题：数据库连接失败

**原因**：数据库配置不正确或数据库服务未启动

**解决方案**：
1. 检查 `.env` 文件中的数据库配置
2. 确认数据库服务正在运行
3. 测试数据库连接：`npm run typeorm -- query "SELECT 1"`

### 问题：迁移失败率高

**原因**：数据格式异常或 URL 格式不标准

**解决方案**：
1. 查看错误详情，找出失败的记录 ID
2. 手动检查这些记录的数据
3. 修复数据格式问题后重新运行迁移

### 问题：迁移后图片无法加载

**原因**：Statically CDN 可能暂时不可用

**解决方案**：
1. 检查 Statically CDN 的健康状态
2. 系统会自动降级到 GitHub Raw 或代理服务
3. 如果问题持续，可以回滚到 jsDelivr

## 技术细节

### 事务处理

迁移脚本使用数据库事务确保数据一致性：
- 每个批次作为一个事务
- 批次内任何失败会回滚整个批次
- 失败的批次不影响其他批次

### 批处理

为了避免内存溢出和提高性能，迁移采用批处理方式：
- 默认批处理大小：100 条记录
- 可通过参数自定义批处理大小
- 每个批次独立处理，互不影响

### URL 匹配

脚本使用正则表达式匹配和转换 URL：
- 精确匹配 jsDelivr 和 Statically 的 URL 格式
- 保留其他 URL 不变
- 支持文本中的多个 URL

### 错误处理

脚本具有完善的错误处理机制：
- 记录每个失败记录的详细信息
- 失败不会中断整个迁移过程
- 提供详细的错误报告

## 相关文件

- `migration.service.ts` - 迁移服务实现
- `migration.script.ts` - CLI 脚本入口
- `migration.service.spec.ts` - 单元测试

## 支持

如有问题，请查看：
1. 迁移报告中的错误详情
2. 应用日志文件
3. 数据库日志

或联系开发团队获取支持。
