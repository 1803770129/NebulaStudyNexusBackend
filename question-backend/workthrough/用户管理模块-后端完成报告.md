# 用户管理模块 — 后端开发完成报告

## 概述

基于双用户表架构（管理端 [User](file:///d:/desktop/program/A_top/NebulaStudyNexusBackend/question-backend/src/modules/user/entities/user.entity.ts#20-72) + 学生端 [Student](file:///d:/desktop/program/A_top/NebulaStudyNexusBackend/question-backend/src/modules/student/entities/student.entity.ts#19-84)），完整实现了后端用户管理模块，包含 3 个新模块、~30 个新文件、~10 个修改文件。**编译验证通过**。

---

## 新增的 API 端点

### 管理端认证 (`/api/auth/*`)

| 方法 | 路径 | 说明 | 状态 |
|------|------|------|------|
| `GET` | `/auth/profile` | 获取管理员个人信息 | **增强** — 返回完整用户对象 |
| `PATCH` | `/auth/profile` | 修改邮箱 | **新增** |
| `PATCH` | `/auth/password` | 修改密码 | **新增** |

### 学生端认证 (`/api/student-auth/*`) — **全部新增**

| 方法 | 路径 | 说明 |
|------|------|------|
| `POST` | `/student-auth/wx-login` | 微信一键登录 |
| `POST` | `/student-auth/register` | 手机号注册 |
| `POST` | `/student-auth/login` | 手机号登录 |
| `POST` | `/student-auth/refresh` | 刷新令牌 |
| `GET` | `/student-auth/profile` | 获取学生信息 |
| `PATCH` | `/student-auth/profile` | 修改昵称/头像 |
| `PATCH` | `/student-auth/password` | 修改密码 |
| `PATCH` | `/student-auth/bind-phone` | 绑定手机号 |
| `PATCH` | `/student-auth/bind-wechat` | 绑定微信 |

### 员工管理 (`/api/users/*`) — **全部新增**

| 方法 | 路径 | 说明 |
|------|------|------|
| `GET` | `/users` | 员工列表（分页+搜索+角色/状态筛选） |
| `GET` | `/users/:id` | 员工详情 |
| `PATCH` | `/users/:id/role` | 修改角色 |
| `PATCH` | `/users/:id/status` | 启用/禁用 |
| `PATCH` | `/users/:id/reset-password` | 重置密码 |
| `DELETE` | `/users/:id` | 删除员工 |

### 学生管理 (`/api/students/*`) — **全部新增**

| 方法 | 路径 | 说明 |
|------|------|------|
| `GET` | `/students` | 学生列表（分页+搜索+状态筛选） |
| `GET` | `/students/:id` | 学生详情 |
| `PATCH` | `/students/:id/status` | 启用/禁用 |
| `DELETE` | `/students/:id` | 删除学生 |

---

## 核心架构变更

### JWT 双类型 Payload

```typescript
// 管理端
{ sub: "uuid", type: "admin", username: "admin", role: "admin" }

// 学生端
{ sub: "uuid", type: "student", nickname: "张三" }
```

- `JwtStrategy.validate()` 根据 `type` 查询 User 或 Student 表
- 验证 `isActive === true`，被禁用的用户即使持有有效 JWT 也会被拦截

### 全局守卫链

```
JwtAuthGuard → RolesGuard → UserTypeGuard
```

- `@Public()` 跳过认证
- `@Roles(UserRole.ADMIN)` 限制角色
- `@UserType('admin')` / `@UserType('student')` 限制用户类型

### 自我保护

所有管理操作（修改角色、禁用、重置密码、删除）都会检查 `currentUserId !== targetId`。

---

## 新增文件清单

```
src/
├── common/
│   ├── decorators/user-type.decorator.ts      # @UserType() 装饰器
│   └── guards/user-type.guard.ts              # UserType 守卫
├── modules/
│   ├── student/
│   │   ├── entities/student.entity.ts          # Student 实体
│   │   ├── student.service.ts                  # Student 服务
│   │   ├── student.controller.ts               # Student 管理控制器
│   │   ├── student.module.ts                   # Student 模块
│   │   └── dto/
│   │       ├── query-student.dto.ts
│   │       ├── update-student-status.dto.ts
│   │       └── index.ts
│   ├── student-auth/
│   │   ├── student-auth.service.ts             # 学生认证服务
│   │   ├── student-auth.controller.ts          # 学生认证控制器
│   │   ├── student-auth.module.ts              # 学生认证模块
│   │   └── dto/
│   │       ├── wx-login.dto.ts
│   │       ├── student-register.dto.ts
│   │       ├── student-login.dto.ts
│   │       ├── update-student-profile.dto.ts
│   │       ├── change-student-password.dto.ts
│   │       ├── bind-phone.dto.ts
│   │       ├── bind-wechat.dto.ts
│   │       └── index.ts
│   ├── user/
│   │   ├── user.controller.ts                  # 员工管理控制器
│   │   └── dto/
│   │       ├── query-user.dto.ts
│   │       ├── update-user-role.dto.ts
│   │       ├── update-user-status.dto.ts
│   │       └── reset-password.dto.ts
│   └── auth/dto/
│       ├── update-admin-profile.dto.ts
│       └── change-admin-password.dto.ts
```

## 修改文件清单

| 文件 | 变更 |
|------|------|
| [auth/strategies/jwt.strategy.ts](file:///d:/desktop/program/A_top/NebulaStudyNexusBackend/question-backend/src/modules/auth/strategies/jwt.strategy.ts) | 双类型 payload + Student 验证 |
| [auth/auth.service.ts](file:///d:/desktop/program/A_top/NebulaStudyNexusBackend/question-backend/src/modules/auth/auth.service.ts) | `type: 'admin'` payload + profile/password 方法 |
| [auth/auth.controller.ts](file:///d:/desktop/program/A_top/NebulaStudyNexusBackend/question-backend/src/modules/auth/auth.controller.ts) | `PATCH /profile`, `PATCH /password` |
| [auth/auth.module.ts](file:///d:/desktop/program/A_top/NebulaStudyNexusBackend/question-backend/src/modules/auth/auth.module.ts) | 导入 StudentModule |
| [user/user.service.ts](file:///d:/desktop/program/A_top/NebulaStudyNexusBackend/question-backend/src/modules/user/user.service.ts) | 分页查询 + admin CRUD + 自我保护 |
| [user/user.module.ts](file:///d:/desktop/program/A_top/NebulaStudyNexusBackend/question-backend/src/modules/user/user.module.ts) | 添加 UserController |
| [common/decorators/current-user.decorator.ts](file:///d:/desktop/program/A_top/NebulaStudyNexusBackend/question-backend/src/common/decorators/current-user.decorator.ts) | 联合类型 JwtPayload |
| [app.module.ts](file:///d:/desktop/program/A_top/NebulaStudyNexusBackend/question-backend/src/app.module.ts) | 导入新模块 + 全局注册守卫 |
| [config/configuration.ts](file:///d:/desktop/program/A_top/NebulaStudyNexusBackend/question-backend/src/config/configuration.ts) | 微信配置 |
| [.env.example](file:///d:/desktop/program/A_top/NebulaStudyNexusBackend/question-backend/.env.example) | WECHAT_APPID / WECHAT_APP_SECRET |
| [main.ts](file:///d:/desktop/program/A_top/NebulaStudyNexusBackend/question-backend/src/main.ts) | Swagger tags |

---

## 验证结果

```
✅ npx nest build → exit code 0（编译通过，无类型错误）
```

## 下一步

1. 配置数据库并运行 `npm run start:dev` 验证运行时行为
2. 在 Swagger (`/api/docs`) 中测试所有新增接口
3. 配置 `WECHAT_APPID` / `WECHAT_APP_SECRET` 后测试微信登录（未配置时返回 503）
4. 开发前端管理页面（员工管理、学生管理）
