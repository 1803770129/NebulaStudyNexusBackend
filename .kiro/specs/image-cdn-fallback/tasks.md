# 实现计划：图片 CDN 混合降级方案

## 概述

本实现计划将图片 CDN 混合降级系统分解为增量式的开发任务。系统采用三层降级策略（Statically CDN → GitHub Raw → 自建代理），确保图片始终能够加载。实现将从核心服务开始，逐步添加前端组件、缓存机制、健康监控和性能优化。

## 任务

- [x] 1. 设置项目结构和核心配置
  - 创建前端和后端目录结构
  - 配置 TypeScript、测试框架（Jest）和属性测试库（fast-check）
  - 设置环境变量配置文件和类型定义
  - 创建共享的类型定义文件（interfaces.ts）
  - _需求：8.1, 8.2, 8.3, 8.4, 8.5, 8.6_

- [x] 2. 实现后端 CDNService 核心功能
  - [x] 2.1 实现 CDNService 类和 URL 生成方法
    - 实现 generateStaticallyURL、generateGitHubRawURL、generateProxyURL 方法
    - 实现 generateFallbackURLs 方法，根据配置生成降级链
    - 实现从环境变量加载配置的 loadConfig 静态方法
    - _需求：1.4, 5.2, 8.1, 8.2, 8.3_
  
  - [ ]* 2.2 编写 CDNService 的属性测试
    - **属性 1：降级链生成完整性**
    - **验证需求：1.4, 5.2**
  
  - [ ]* 2.3 编写 CDNService 的属性测试
    - **属性 2：降级链顺序可配置**
    - **验证需求：1.6, 8.2**
  
  - [ ]* 2.4 编写 CDNService 的属性测试
    - **属性 20：CDN 启用/禁用配置**
    - **验证需求：8.3**
  
  - [ ]* 2.5 编写 CDNService 的属性测试
    - **属性 21：自定义 URL 附加**
    - **验证需求：8.7**

- [x] 3. 实现 HealthMonitor 健康检查服务
  - [x] 3.1 实现 HealthMonitor 类
    - 实现 checkHealth 方法，带缓存逻辑
    - 实现 performHealthCheck 私有方法，执行实际的 HTTP 请求
    - 实现 getAllHealthStatus 方法
    - 实现缓存清理和过期逻辑
    - _需求：4.1, 4.2, 4.3, 4.4, 4.5_
  
  - [ ]* 3.2 编写 HealthMonitor 的属性测试
    - **属性 8：健康检查响应**
    - **验证需求：4.2, 4.3, 4.4**
  
  - [ ]* 3.3 编写 HealthMonitor 的属性测试
    - **属性 9：健康检查缓存**
    - **验证需求：4.5, 8.5**
  
  - [ ]* 3.4 编写健康检查端点的单元测试
    - **示例 2：健康检查端点存在**
    - **验证需求：4.1**

- [x] 4. 实现 ProxyService 代理服务
  - [x] 4.1 实现 ProxyService 类
    - 实现 proxyImage 方法，从 GitHub 获取图片
    - 实现 fetchFromGitHub 私有方法
    - 实现 compressImage 方法（使用 sharp 库）
    - 实现 generateETag 方法
    - 处理 GitHub API 限流错误
    - _需求：5.3, 5.4, 5.5, 10.3_
  
  - [ ]* 4.2 编写 ProxyService 的属性测试
    - **属性 11：代理服务缓存头**
    - **验证需求：5.4, 8.6, 10.4**
  
  - [ ]* 4.3 编写 ProxyService 的属性测试
    - **属性 28：图片压缩参数**
    - **验证需求：10.3**
  
  - [ ]* 4.4 编写代理服务端点的单元测试
    - **示例 3：代理服务端点功能**
    - 测试 GitHub API 限流处理
    - **验证需求：5.3, 5.5**

- [x] 5. 实现图片上传接口增强
  - [x] 5.1 增强上传接口，返回所有降级 URL
    - 修改上传响应，添加 urls 对象（statically, github, proxy）
    - 保持向后兼容性，url 字段返回 Statically URL
    - _需求：5.1, 5.6, 5.7_
  
  - [ ]* 5.2 编写上传接口的属性测试
    - **属性 10：上传响应完整性**
    - **验证需求：5.1, 5.6, 5.7**

- [x] 6. 检查点 - 确保后端服务测试通过
  - 确保所有后端测试通过，如有问题请询问用户

- [ ] 7. 实现前端 URLCache 服务
  - [ ] 7.1 实现 URLCache 类
    - 实现 get、set、remove 方法
    - 支持 localStorage 和 IndexedDB 两种存储
    - 实现 cleanup 方法，清理过期条目
    - 实现 getStats 方法，返回缓存统计
    - _需求：3.1, 3.2, 3.3, 3.4, 3.5, 10.5_
  
  - [ ]* 7.2 编写 URLCache 的属性测试
    - **属性 4：成功 URL 缓存**
    - **验证需求：1.5, 3.1, 3.2**
  
  - [ ]* 7.3 编写 URLCache 的属性测试
    - **属性 5：缓存持久化**
    - **验证需求：3.3, 10.5**
  
  - [ ]* 7.4 编写 URLCache 的属性测试
    - **属性 6：缓存失效和重试**
    - **验证需求：3.4**
  
  - [ ]* 7.5 编写 URLCache 的属性测试
    - **属性 7：缓存过期**
    - **验证需求：3.5, 8.4**

- [x] 8. 实现前端 ImageLoader 组件
  - [x] 8.1 实现 ImageLoader React 组件
    - 实现组件状态管理（loading, loaded, error）
    - 实现 loadImage 方法，带超时和降级逻辑
    - 实现 tryNextUrl 方法，自动尝试下一个 URL
    - 实现 retry 方法，从头开始重试
    - 实现懒加载逻辑（使用 Intersection Observer）
    - 实现 UI 渲染：加载指示器、图片、错误状态
    - _需求：1.1, 1.2, 1.3, 2.1, 2.2, 2.3, 2.4, 7.1, 7.2, 7.3, 7.4, 7.5, 10.2_
  
  - [ ]* 8.2 编写 ImageLoader 的属性测试
    - **属性 3：自动降级重试**
    - **验证需求：1.1, 1.2, 2.1**
  
  - [ ]* 8.3 编写 ImageLoader 的属性测试
    - **属性 16：加载状态展示**
    - **验证需求：2.2, 7.1, 7.2**
  
  - [ ]* 8.4 编写 ImageLoader 的属性测试
    - **属性 17：重试从头开始**
    - **验证需求：2.4**
  
  - [ ]* 8.5 编写 ImageLoader 的属性测试
    - **属性 18：状态平滑过渡**
    - **验证需求：7.5**
  
  - [ ]* 8.6 编写 ImageLoader 的属性测试
    - **属性 27：懒加载行为**
    - **验证需求：10.2**
  
  - [ ]* 8.7 编写 ImageLoader 的单元测试
    - **示例 1：所有 URL 失败显示错误状态**
    - **验证需求：1.3, 2.3, 7.3, 7.4**

- [ ] 9. 实现 PerformanceMonitor 性能监控服务
  - [ ] 9.1 实现 PerformanceMonitor 类
    - 实现 startLoad 和 endLoad 方法
    - 实现 getMetrics 方法，计算聚合指标
    - 实现 exportMetrics 方法，导出为 JSON 格式
    - _需求：6.5, 10.7_
  
  - [ ]* 9.2 编写 PerformanceMonitor 的属性测试
    - **属性 15：性能指标收集**
    - **验证需求：6.5, 10.7**

- [ ] 10. 实现错误处理和日志记录
  - [ ] 10.1 实现统一的错误日志格式
    - 创建 ErrorLog 接口和日志工具函数
    - 在 ImageLoader 中集成错误日志
    - 在后端服务中集成错误日志
    - _需求：6.1, 6.2, 6.3, 6.4_
  
  - [ ]* 10.2 编写错误处理的属性测试
    - **属性 12：错误类型区分**
    - **验证需求：6.1, 6.3**
  
  - [ ]* 10.3 编写错误处理的属性测试
    - **属性 13：降级失败日志**
    - **验证需求：6.2**
  
  - [ ]* 10.4 编写错误处理的属性测试
    - **属性 14：降级成功警告**
    - **验证需求：6.4**

- [x] 11. 检查点 - 确保前端组件测试通过
  - 确保所有前端测试通过，如有问题请询问用户

- [x] 12. 实现 jsDelivr 到 Statically 迁移功能
  - [x] 12.1 实现 MigrationScript 类
    - 实现 migrate 方法，批量更新数据库
    - 实现 convertURL 方法，转换 URL 格式
    - 实现 isJsDelivrURL 和 isStaticallyURL 验证方法
    - 实现 rollback 方法
    - 实现 generateReport 方法
    - 支持试运行模式（dryRun）
    - _需求：9.1, 9.2, 9.3, 9.4, 9.5, 9.6_
  
  - [ ]* 12.2 编写 MigrationScript 的属性测试
    - **属性 22：URL 格式识别**
    - **验证需求：9.2**
  
  - [ ]* 12.3 编写 MigrationScript 的属性测试
    - **属性 23：jsDelivr URL 自动转换**
    - **验证需求：9.3**
  
  - [ ]* 12.4 编写 MigrationScript 的属性测试
    - **属性 24：迁移日志记录**
    - **验证需求：9.4**
  
  - [ ]* 12.5 编写 MigrationScript 的属性测试
    - **属性 25：迁移往返一致性**
    - **验证需求：9.5**
  
  - [ ]* 12.6 编写 MigrationScript 的属性测试
    - **属性 26：迁移验证报告**
    - **验证需求：9.6**
  
  - [ ]* 12.7 编写迁移脚本的单元测试
    - **示例 4：迁移脚本功能**
    - 测试试运行模式
    - **验证需求：9.1**

- [-] 13. 在 ImageLoader 中集成 jsDelivr URL 自动转换
  - [ ] 13.1 在 ImageLoader 中添加 URL 转换逻辑
    - 检测 jsDelivr URL 并自动转换为 Statically URL
    - 集成到 loadImage 方法中
    - _需求：9.3_

- [ ] 14. 实现 API 端点
  - [ ] 14.1 创建健康检查 API 端点
    - GET /api/health/cdn - 返回所有 CDN 健康状态
    - GET /api/health/cdn/:cdnType - 返回单个 CDN 健康状态
    - _需求：4.1_
  
  - [ ] 14.2 创建代理服务 API 端点
    - GET /api/upload/proxy/:filename - 代理图片请求
    - 支持 query 参数：width, height, quality
    - 设置适当的缓存头
    - _需求：5.3, 5.4_
  
  - [ ] 14.3 创建性能指标 API 端点
    - GET /api/metrics/cdn - 返回性能指标
    - _需求：6.5, 10.7_

- [ ] 15. 实现配置管理和验证
  - [ ] 15.1 实现配置验证逻辑
    - 验证所有环境变量的类型和范围
    - 提供默认值和清晰的错误信息
    - _需求：8.1, 8.2, 8.3, 8.4, 8.5, 8.6_
  
  - [ ]* 15.2 编写配置管理的属性测试
    - **属性 19：超时阈值配置**
    - **验证需求：8.1**

- [ ] 16. 实现性能优化功能
  - [ ] 16.1 实现图片预加载机制
    - 在 ImageLoader 中添加预加载逻辑
    - 预加载即将进入视口的图片
    - _需求：10.1_
  
  - [ ] 16.2 实现缓存 URL 跳过健康检查优化
    - 在 ImageLoader 中，使用缓存 URL 时跳过健康检查
    - _需求：10.6_
  
  - [ ]* 16.3 编写性能优化的属性测试
    - **属性 29：缓存 URL 跳过健康检查**
    - **验证需求：10.6**
  
  - [ ]* 16.4 编写预加载机制的单元测试
    - **示例 5：预加载机制**
    - **验证需求：10.1**

- [ ] 17. 集成和端到端测试
  - [ ] 17.1 编写端到端集成测试
    - 测试完整的上传 → URL 生成 → 前端加载 → 降级 → 缓存流程
    - 使用模拟的 CDN 响应
    - 测试所有降级场景
  
  - [ ] 17.2 编写性能基准测试
    - 测试并发加载多个图片
    - 测试缓存命中率和降级率
    - 测试代理服务吞吐量

- [ ] 18. 最终检查点 - 确保所有测试通过
  - 运行所有单元测试、属性测试和集成测试
  - 检查代码覆盖率（行覆盖率 ≥ 80%，分支覆盖率 ≥ 75%）
  - 确保所有 29 个核心属性都有对应的属性测试
  - 确保所有 5 个示例测试用例都有对应的单元测试
  - 如有问题请询问用户

## 注意事项

- 标记 `*` 的任务是可选的，可以跳过以加快 MVP 开发
- 每个任务都引用了具体的需求，确保可追溯性
- 检查点确保增量验证
- 属性测试验证通用正确性属性
- 单元测试验证特定示例和边缘情况
- 所有属性测试应配置为最少运行 100 次迭代
- 使用 fast-check 库进行属性测试
- 每个属性测试必须用注释标记，引用设计文档中的属性编号
